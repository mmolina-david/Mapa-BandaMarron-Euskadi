<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa Banda Marrón Euskadi</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <!-- ✅ PMTiles (para usar pmtiles:// en MapLibre) -->
  <script src="https://unpkg.com/pmtiles@^4.0/dist/pmtiles.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    /* =========================
       PANEL: tamaño y scroll
       ========================= */
    #uiPanel{
      position:absolute;
      left: 20px;
      bottom: 20px;
      z-index: 30;
      font-family: sans-serif;
      user-select: none;
      width: 360px;
      max-height: calc(100vh - 40px);
    }
    .panel-wrap{
      position: relative;
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.22);
      overflow: hidden;
      max-height: calc(100vh - 40px);
    }
    .panel-content{
      max-height: calc(100vh - 40px);
      overflow: auto;
    }

    .panel-section{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.10);
      background: transparent;
    }
    .panel-section:last-child{ border-bottom:0; }

    #panelToggle{
      position:absolute;
      right:-18px;
      top:50%;
      transform: translateY(-50%);
      width: 18px;
      height: 56px;
      border-radius: 0 12px 12px 0;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 0 10px rgba(0,0,0,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      border: 1px solid rgba(0,0,0,0.10);
      border-left:0;
      z-index: 31;
    }
    #panelToggle span{ font-size:14px; opacity:.85; line-height:1; }

    #uiPanel.collapsed{ width:0; }
    #uiPanel.collapsed .panel-wrap{
      width:0;
      background: transparent;
      box-shadow:none;
      overflow: visible;
    }
    #uiPanel.collapsed .panel-content{ display:none; }
    #uiPanel.collapsed #panelToggle{
      right:auto;
      left:-18px;
      top:50%;
      transform: translateY(-50%);
      border-radius: 12px 0 0 12px;
      border-left: 1px solid rgba(0,0,0,0.10);
      border-right:0;
    }

    /* =========================
       Selector basemap
       ========================= */
    .bm-button{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0;
      border:0;
      background:transparent;
      cursor:pointer;
      font-size:13px;
      line-height:1;
    }
    .bm-logo{ width:28px; height:28px; object-fit:contain; flex:0 0 28px; }
    .bm-current{
      display:flex; flex-direction:column; gap:3px; align-items:flex-start;
      flex:1; min-width:0;
    }
    .bm-current .bm-label{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bm-current .bm-sub{ font-size:12px; opacity:.75; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bm-caret{ font-size:14px; opacity:.8; }

    .bm-panel{
      display:none;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(0,0,0,0.10);
      background:transparent;
    }
    .bm-panel.open{ display:block; }

    .bm-title{ font-size:12px; font-weight:700; margin-bottom:8px; }
    .bm-options{
      display:grid;
      grid-template-columns:1fr;
      gap:6px;
      max-height:220px;
      overflow:auto;
      padding-right:2px;
    }
    .bm-option{
      width:100%;
      text-align:left;
      padding:7px 8px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.10);
      background:white;
      cursor:pointer;
      font-size:13px;
    }
    .bm-option:hover{ background: rgba(0,0,0,0.04); }
    .bm-option.active{ border-color: rgba(0,0,0,0.35); font-weight:700; }

    /* =========================
       Leyenda
       ========================= */
    .legend-title{
      font-weight:bold;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
    }
    .legend-actions button{
      font-size:12px;
      padding:2px 6px;
      cursor:pointer;
    }
    .legend-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
      font-size:13px;
    }
    .legend-left{ display:flex; align-items:center; gap:8px; }
    .legend-color{
      width:14px; height:14px;
      border:1px solid #333;
      border-radius:3px;
      flex:0 0 14px;
    }
    .legend-item input[type="checkbox"]{ transform: scale(1.05); cursor:pointer; }

    /* =========================
       Slider año
       ========================= */
    .year-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #yearLabel{
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    #yearSlider{ width:100%; flex:1 1 auto; }
    .year-hint{
      font-size:11px;
      opacity:.7;
      margin-top:6px;
      line-height:1.2;
    }

    /* =========================
       Modal
       ========================= */
    #modalOverlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.35);
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    #modalBox{
      width: min(520px, 92vw);
      background:white;
      border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      padding:16px 16px 12px 16px;
      font-family:sans-serif;
    }
    #modalBox h3{ margin:0 0 8px 0; font-size:16px; }
    #modalBox p{ margin:0 0 12px 0; font-size:13px; line-height:1.4; opacity:.9; }
    #modalClose{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:0;
      background: rgba(0,0,0,0.08);
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
    }
    #modalClose:hover{ background: rgba(0,0,0,0.12); }

    /* =========================
       Popup
       ========================= */
    .mfv-popup .maplibregl-popup-content{
      border-radius:12px;
      padding:10px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      font-family:sans-serif;
      min-width: 250px;
    }
    .mfv-popup .maplibregl-popup-close-button{
      font-size:18px;
      padding:2px 8px;
      opacity:.7;
    }

    /* =========================
       Tabs: Leyenda / Tesela
       ========================= */
    .tabs{
      position: sticky;
      top: 0;
      z-index: 5;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.92);
      border-bottom: 1px solid rgba(0,0,0,0.10);
      backdrop-filter: blur(4px);
    }
    .tab-btn{
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(0,0,0,0.04);
      padding: 8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 13px;
      font-weight: 800;
      opacity: .9;
    }
    .tab-btn[aria-selected="true"]{
      background: rgba(255,255,255,0.98);
      border-color: rgba(0,0,0,0.22);
      opacity: 1;
    }
    .tab-panel{ padding: 0; }
    .tab-panel[hidden]{ display:none; }

    /* ==========================================================
       Tesela: 3 cards apiladas (Ubicación -> Afección -> MFCAE)
       + contenido compacto y legible
       ========================================================== */
    .click-tab{
      display:grid;
      gap:10px;
      padding: 10px 12px 12px 12px;
    }
    .card{
      border:1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.97);
    }
    .card h3{
      margin:0 0 8px 0;
      font-size: 13px;
      font-weight: 900;
    }

    .kv{
      display:grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 6px 10px;
      font-size: 12.5px;
      line-height: 1.25;
      align-items: start;
    }
    .kv .k{
      color: rgba(0,0,0,0.62);
      font-weight: 800;
      white-space: nowrap;
    }
    .kv .v{
      color: rgba(0,0,0,0.92);
      font-weight: 700;
      text-align: right;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    /* Para valores “largos” (Afección %) hacemos bloque compacto */
    .kv .v.long {
      text-align: left;
      font-weight: 650;
      line-height: 1.25;
      padding-top: 2px;
    }

    .empty-click{
      border:1px dashed rgba(0,0,0,0.18);
      background: rgba(0,0,0,0.02);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12.5px;
      opacity: .85;
      line-height: 1.35;
    }

    @media (max-width: 480px){
      #uiPanel{ width: 92vw; left: 4vw; bottom: 14px; }
      .kv{ grid-template-columns: 130px minmax(0,1fr); }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="modalOverlay" role="dialog" aria-modal="true">
    <div id="modalBox">
      <h3>Aviso</h3>
      <p>Este repositorio permite visualizar los resultados del TFG del Grado en Ingeniería Forestal:

      "Aplicación de la teledetección y los modelos de aprendizaje automático para la detección y seguimiento de daños
      causados por la banda marrón (Lecanosticta acicola) en masas de Pinus radiata en Euskadi"
        
      Autor: David Martín Molina
      Tutora: Silvia Merino de Miguel</p>
      <button id="modalClose" type="button">Entendido</button>
    </div>
  </div>

  <div id="uiPanel">
    <div id="panelToggle" title="Ocultar/mostrar panel"><span id="toggleIcon">❯</span></div>

    <div class="panel-wrap">
      <div class="panel-content">

        <div class="tabs" role="tablist" aria-label="Panel">
          <button id="tab-controls" class="tab-btn" role="tab" aria-controls="panel-controls" aria-selected="true" type="button">Leyenda</button>
          <button id="tab-click" class="tab-btn" role="tab" aria-controls="panel-click" aria-selected="false" type="button">Tesela</button>
        </div>

        <!-- ===== Panel LEYENDA ===== -->
        <div id="panel-controls" class="tab-panel" role="tabpanel" aria-labelledby="tab-controls">

          <div class="panel-section">
            <button id="bmBtn" class="bm-button" type="button" aria-haspopup="listbox" aria-expanded="false">
              <img id="bmLogo" class="bm-logo" alt="geoEuskadi" />
              <div class="bm-current">
                <div id="bmYearLabel" class="bm-label">2018</div>
                <div class="bm-sub">Ortofoto (RGB)</div>
              </div>
              <div class="bm-caret">▾</div>
            </button>

            <div id="bmPanel" class="bm-panel" role="listbox" aria-label="Selector de ortofoto">
              <div class="bm-title">Fuente: Eusko Jaurlaritza / Gobierno Vasco. geoEuskadi</div>
              <div id="bmOptions" class="bm-options"></div>
            </div>
          </div>

          <div class="panel-section">
            <div class="legend-title">
              <span>Nivel de afección</span>
              <span class="legend-actions">
                <button id="allBtn" type="button">Todas</button>
                <button id="noneBtn" type="button">Ninguna</button>
              </span>
            </div>

            <label class="legend-item">
              <span class="legend-left">
                <span class="legend-color" style="background:#bdbdbd;"></span>
                <span>Sin datos</span>
              </span>
              <input type="checkbox" class="class-toggle" value="-1" checked />
            </label>

            <label class="legend-item">
              <span class="legend-left">
                <span class="legend-color" style="background:#a6d96a;"></span>
                <span>Sano (0%)</span>
              </span>
              <input type="checkbox" class="class-toggle" value="0" checked />
            </label>

            <label class="legend-item">
              <span class="legend-left">
                <span class="legend-color" style="background:#ffffc0;"></span>
                <span>Leve (&lt;20%)</span>
              </span>
              <input type="checkbox" class="class-toggle" value="1" checked />
            </label>

            <label class="legend-item">
              <span class="legend-left">
                <span class="legend-color" style="background:#fdae61;"></span>
                <span>Moderado (20-60%)</span>
              </span>
              <input type="checkbox" class="class-toggle" value="2" checked />
            </label>

            <label class="legend-item" style="margin-bottom:0;">
              <span class="legend-left">
                <span class="legend-color" style="background:#d7191c;"></span>
                <span>Grave (&gt;60%)</span>
              </span>
              <input type="checkbox" class="class-toggle" value="3" checked />
            </label>
          </div>

          <div class="panel-section">
            <div class="year-row">
              <div id="yearLabel">2018</div>
              <input id="yearSlider" type="range" min="0" max="0" step="1" value="0" />
            </div>
          </div>

        </div>

        <!-- ===== Panel TESELA (3 cards apiladas) ===== -->
        <div id="panel-click" class="tab-panel" role="tabpanel" aria-labelledby="tab-click" hidden>
          <div id="clickTabContent" class="click-tab">
            <div class="empty-click">
              Aún no has pinchado en una tesela.<br/>
              Pincha sobre el mapa (capa MFV) y aquí aparecerán los cuadros con Ubicación + Afección + Mapa Forestal.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const LOGO_URL = './data/geoeuskadi.png';

    const YEARS = [2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025];
    const DEFAULT_YEAR = 2018;

    function mfvPmtilesForYear(year) {
      return `./data/${year}_afeccion_EPSG4326.pmtiles`;
    }

    function mfvSourceLayerForYear(year) {
      return 'mfv';
    }

    // ✅ relleno desaparece a partir de este zoom (sólo borde)
    const FILL_CUTOFF_ZOOM = 13;

    const DETAIL_ZOOM = 13;

    const CLASS_COLORS = {
      '-1': '#bdbdbd',
      0: '#a6d96a',
      1: '#ffffc0',
      2: '#fdae61',
      3: '#d7191c'
    };

    const ORTO_YEARS = [
      2024, 2023, 2022, 2021, 2020, 2019, 2018,
      2017, 2016, 2015, 2014, 2013, 2012, 2011,
      2010, 2009, 2008, 2007, 2006, 2005, 2004,
      2002, 2001, 1995, 1991, 1989, 1984
    ];

    function wmsTileUrlForYear(year) {
      return "https://www.geo.euskadi.eus/WMS_ORTOARGAZKIAK" +
        "?service=WMS&request=GetMap&version=1.3.0" +
        "&layers=ORTO_" + year +
        "&styles=default" +
        "&format=image/png" +
        "&transparent=false" +
        "&CRS=EPSG:3857" +
        "&BBOX={bbox-epsg-3857}" +
        "&WIDTH=256&HEIGHT=256";
    }

    // normaliza clase: 3.0 -> 3
    function claseIntExpr() {
      return ['case',
        ['all', ['has', 'clase'], ['!=', ['get', 'clase'], null]],
        ['to-number', ['round', ['to-number', ['get', 'clase']]]],
        -1
      ];
    }

    function colorExprForClase() {
      return [
        'match',
        claseIntExpr(),
        -1, CLASS_COLORS['-1'],
        0, CLASS_COLORS[0],
        1, CLASS_COLORS[1],
        2, CLASS_COLORS[2],
        3, CLASS_COLORS[3],
        CLASS_COLORS['-1']
      ];
    }

    function fillOpacityExpr() {
      return [
        'interpolate', ['linear'], ['zoom'],
        0, 0.65,
        FILL_CUTOFF_ZOOM - 0.01, 0.65,
        FILL_CUTOFF_ZOOM, 0.00,
        24, 0.00
      ];
    }

    function lineWidthExpr() {
      return [
        'interpolate', ['linear'], ['zoom'],
        6, 0.45,
        10, 0.9,
        DETAIL_ZOOM, 1.25,
        16, 1.9
      ];
    }

    // PMTiles protocol
    const pmtilesProtocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", pmtilesProtocol.tile);

    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          satellite: {
            type: 'raster',
            tiles: [ wmsTileUrlForYear(DEFAULT_YEAR) ],
            tileSize: 256
          }
        },
        layers: [
          { id: 'satellite', type: 'raster', source: 'satellite', minzoom: 0, maxzoom: 24 }
        ]
      },
      center: [-2.7, 43.1],
      zoom: 7
    });

    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: 'metric' }), 'bottom-right');

    // Auto-zoom leyendo header
    let didAutoZoom = false;
    async function autoZoomToPmtiles(year) {
      if (didAutoZoom) return;
      const pmtilesPath = mfvPmtilesForYear(year);
      try {
        const p = new pmtiles.PMTiles(pmtilesPath);
        const h = await p.getHeader();
        if (![h?.minLon, h?.minLat, h?.maxLon, h?.maxLat].every(Number.isFinite)) return;
        const bounds = [[h.minLon, h.minLat], [h.maxLon, h.maxLat]];
        map.fitBounds(bounds, { padding: 40, duration: 700, maxZoom: 12.8 });
        didAutoZoom = true;
      } catch (_) {}
    }

    // Modal
    const modalOverlay = document.getElementById('modalOverlay');
    document.getElementById('modalClose').addEventListener('click', () => { modalOverlay.style.display = 'none'; });
    modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.style.display = 'none'; });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modalOverlay.style.display = 'none'; });

    // Toggle panel
    const uiPanel = document.getElementById('uiPanel');
    const panelToggle = document.getElementById('panelToggle');
    const toggleIcon = document.getElementById('toggleIcon');

    function setPanelOpen(open) {
      if (open) { uiPanel.classList.remove('collapsed'); toggleIcon.textContent = '❯'; }
      else { uiPanel.classList.add('collapsed'); toggleIcon.textContent = '❮'; }
    }
    panelToggle.addEventListener('click', (e) => { e.stopPropagation(); setPanelOpen(uiPanel.classList.contains('collapsed')); });
    setPanelOpen(true);

    // Tabs
    const tabControlsBtn = document.getElementById('tab-controls');
    const tabClickBtn    = document.getElementById('tab-click');
    const panelControls  = document.getElementById('panel-controls');
    const panelClick     = document.getElementById('panel-click');

    function selectPanelTab(which) {
      const isControls = which === 'controls';
      tabControlsBtn.setAttribute('aria-selected', isControls ? 'true' : 'false');
      tabClickBtn.setAttribute('aria-selected', isControls ? 'false' : 'true');
      panelControls.hidden = !isControls;
      panelClick.hidden = isControls;
    }
    tabControlsBtn.addEventListener('click', () => selectPanelTab('controls'));
    tabClickBtn.addEventListener('click', () => selectPanelTab('click'));

    // Basemap selector
    const bmBtn = document.getElementById('bmBtn');
    const bmPanel = document.getElementById('bmPanel');
    const bmOptions = document.getElementById('bmOptions');
    const bmYearLabel = document.getElementById('bmYearLabel');
    const bmLogo = document.getElementById('bmLogo');
    bmLogo.src = LOGO_URL;

    let selectedOrtoYear = DEFAULT_YEAR;
    bmYearLabel.textContent = String(selectedOrtoYear);

    function updateBasemapUI(year) {
      bmYearLabel.textContent = String(year);
      Array.from(bmOptions.querySelectorAll('.bm-option')).forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.year) === year);
      });
    }

    function ensureBasemapBelow() {
      if (map.getLayer('satellite') && map.getLayer('mfv-fill')) {
        try { map.moveLayer('satellite', 'mfv-fill'); } catch (_) {}
      }
    }

    function setBasemapYear(year) {
      selectedOrtoYear = year;
      updateBasemapUI(year);

      const tiles = [ wmsTileUrlForYear(year) ];
      const src = map.getSource('satellite');

      if (src && typeof src.setTiles === 'function') {
        src.setTiles(tiles);
        ensureBasemapBelow();
        return;
      }

      if (map.getLayer('satellite')) map.removeLayer('satellite');
      if (map.getSource('satellite')) map.removeSource('satellite');

      map.addSource('satellite', { type: 'raster', tiles, tileSize: 256 });

      if (map.getLayer('mfv-fill')) {
        map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite', minzoom: 0, maxzoom: 24 }, 'mfv-fill');
      } else {
        map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite' });
      }
    }

    function renderBasemapOptions() {
      bmOptions.innerHTML = '';
      ORTO_YEARS.forEach(y => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bm-option' + (y === selectedOrtoYear ? ' active' : '');
        btn.textContent = String(y);
        btn.dataset.year = String(y);
        btn.addEventListener('click', () => { setBasemapYear(y); closeBasemapPanel(); });
        bmOptions.appendChild(btn);
      });
    }

    function openBasemapPanel() { bmPanel.classList.add('open'); bmBtn.setAttribute('aria-expanded', 'true'); }
    function closeBasemapPanel() { bmPanel.classList.remove('open'); bmBtn.setAttribute('aria-expanded', 'false'); }
    function toggleBasemapPanel() { bmPanel.classList.contains('open') ? closeBasemapPanel() : openBasemapPanel(); }

    bmBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleBasemapPanel(); });
    document.addEventListener('click', () => closeBasemapPanel());
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeBasemapPanel(); });

    renderBasemapOptions();
    updateBasemapUI(DEFAULT_YEAR);

    // Slider
    const yearSlider = document.getElementById('yearSlider');
    const yearLabel  = document.getElementById('yearLabel');

    function yearFromIndex(i) {
      const idx = Math.max(0, Math.min(YEARS.length - 1, Number(i)));
      return YEARS[idx];
    }

    let activeYear = DEFAULT_YEAR;

    function initYearSlider() {
      yearSlider.min = 0;
      yearSlider.max = String(YEARS.length - 1);
      yearSlider.step = 1;
      const startIdx = Math.max(0, YEARS.indexOf(DEFAULT_YEAR));
      yearSlider.value = String(startIdx);
      activeYear = yearFromIndex(yearSlider.value);
      yearLabel.textContent = String(activeYear);
    }

    // Filtros
    function selectedClasses() {
      const toggles = Array.from(document.querySelectorAll('.class-toggle'));
      return toggles.filter(cb => cb.checked).map(cb => Number(cb.value));
    }

    function applyClassFilter() {
      const selected = selectedClasses();
      const hide = (selected.length === 0);
      const filter = hide ? null : ['in', claseIntExpr(), ['literal', selected]];

      ['mfv-fill','mfv-line'].forEach(layerId => {
        if (!map.getLayer(layerId)) return;
        if (hide) map.setLayoutProperty(layerId, 'visibility', 'none');
        else {
          map.setLayoutProperty(layerId, 'visibility', 'visible');
          map.setFilter(layerId, filter);
        }
      });
    }

    function applyStyle() {
      if (map.getLayer('mfv-fill')) {
        map.setPaintProperty('mfv-fill', 'fill-color', colorExprForClase());
        map.setPaintProperty('mfv-fill', 'fill-opacity', fillOpacityExpr());
      }
      if (map.getLayer('mfv-line')) map.setPaintProperty('mfv-line', 'line-color', colorExprForClase());
      applyClassFilter();
      ensureBasemapBelow();
    }

    function initLegendHandlers() {
      const toggles = Array.from(document.querySelectorAll('.class-toggle'));
      const allBtn = document.getElementById('allBtn');
      const noneBtn = document.getElementById('noneBtn');

      toggles.forEach(cb => cb.addEventListener('change', applyClassFilter));
      allBtn.addEventListener('click', () => { toggles.forEach(cb => cb.checked = true); applyClassFilter(); });
      noneBtn.addEventListener('click', () => { toggles.forEach(cb => cb.checked = false); applyClassFilter(); });
    }

    // Popup
    let mfvPopup = null;

    function formatNumberSpace(n, digits = 2) {
      const num = Number(n);
      if (!Number.isFinite(num)) return '—';
      const s = new Intl.NumberFormat('es-ES', {
        useGrouping: true,
        minimumFractionDigits: 0,
        maximumFractionDigits: digits
      }).format(num);
      return s.replace(/\./g, ' ');
    }

    function popupHTML(props) {
      const sup = formatNumberSpace(props?.sup, 2);
      const rawCls = Number(props?.clase);
      const cls = Number.isFinite(rawCls) ? Math.round(rawCls) : -1;
      const badgeColor = (String(cls) in CLASS_COLORS) ? CLASS_COLORS[String(cls)] : CLASS_COLORS['-1'];

      const Afeccion = (Number.isFinite(cls) && cls === -1)
        ? 'Sin datos disponibles'
        : (props?.Afeccion ?? '—');

      return `
        <div style="display:flex;justify-content:flex-end;margin:0 0 8px 0;">
          <div style="width:12px;height:12px;border-radius:4px;border:1px solid rgba(0,0,0,0.18);background:${badgeColor};"></div>
        </div>
        <div style="display:grid;gap:8px;font-size:12.5px;line-height:1.25;">
          <div style="display:flex;justify-content:space-between;gap:12px;border-top:0;padding-top:0;">
            <div style="font-weight:800;opacity:.75;">Superficie (ha):</div>
            <div style="font-weight:800;text-align:right;">${sup}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;border-top:1px solid rgba(0,0,0,0.08);padding-top:8px;">
            <div style="font-weight:800;opacity:.75;">Afección:</div>
            <div style="text-align:right;font-weight:700;opacity:.92;">${Afeccion}</div>
          </div>
        </div>
      `;
    }

    function closeMfvPopup() { if (mfvPopup) { mfvPopup.remove(); mfvPopup = null; } }
    function openMfvPopup(lngLat, feature) {
      closeMfvPopup();
      mfvPopup = new maplibregl.Popup({ closeButton: true, closeOnClick: true, maxWidth: '380px', offset: 10 })
        .setLngLat(lngLat)
        .setHTML(popupHTML(feature.properties || {}))
        .addTo(map);
      try { mfvPopup.getElement().classList.add('mfv-popup'); } catch (_) {}
    }

    function setPointerCursor(on) { map.getCanvas().style.cursor = on ? 'pointer' : ''; }

    // PMTiles layers/source
    function removeMfvLayersAndSource() {
      closeMfvPopup();
      ['mfv-fill','mfv-line'].forEach(id => { if (map.getLayer(id)) map.removeLayer(id); });
      if (map.getSource('mfv')) map.removeSource('mfv');
    }

    function addMfvSourceAndLayersForYear(year) {
      const pmtilesPath = mfvPmtilesForYear(year);
      const sourceLayer = mfvSourceLayerForYear(year);

      map.addSource('mfv', { type: 'vector', url: `pmtiles://${pmtilesPath}` });

      map.addLayer({
        id: 'mfv-fill',
        type: 'fill',
        source: 'mfv',
        'source-layer': sourceLayer,
        paint: {
          'fill-color': colorExprForClase(),
          'fill-opacity': fillOpacityExpr()
        }
      });

      map.addLayer({
        id: 'mfv-line',
        type: 'line',
        source: 'mfv',
        'source-layer': sourceLayer,
        paint: {
          'line-color': colorExprForClase(),
          'line-width': lineWidthExpr(),
          'line-opacity': 0.95
        }
      });

      applyStyle();
    }

    async function loadMfvYear(year) {
      removeMfvLayersAndSource();
      addMfvSourceAndLayersForYear(year);
      await new Promise(resolve => map.once('idle', resolve));
    }

    // Tesela tab render (3 cards)
    const clickTabContent = document.getElementById('clickTabContent');

    function safeText(v) {
      if (v === null || v === undefined || v === '') return 'sin datos';
      return String(v);
    }
    function fmtNum(v, decimals = 2) {
      const n = Number(v);
      if (!Number.isFinite(n)) return 'sin datos';
      return new Intl.NumberFormat('es-ES', { maximumFractionDigits: decimals, minimumFractionDigits: 0 }).format(n);
    }

    function renderClickTab(props, xyString) {
      clickTabContent.innerHTML = `
        <div class="card">
          <h3>Ubicación</h3>
          <div class="kv">
            <div class="k">XY</div><div class="v">${safeText(xyString)}</div>
            <div class="k">Municipio</div><div class="v">${safeText(props?.NOMBRE_TOP)}</div>
            <div class="k">Provincia</div><div class="v">${safeText(props?.TERRITORIO)}</div>
            <div class="k">Comarca</div><div class="v">${safeText(props?.COMARC_EUS)}</div>
          </div>
        </div>

        <div class="card">
          <h3>Afección</h3>
          <div class="kv">
            <div class="k">Afección mayoritaria</div><div class="v">${safeText(props?.nom_clase)}</div>
            <div class="k">Estado de la tesela</div><div class="v long">${safeText(props?.Afeccion)}</div>
          </div>
        </div>

        <div class="card">
          <h3>Info. Mapa Forestal (MFCAE)</h3>
          <div class="kv">
            <div class="k">Superficie (ha)</div><div class="v">${fmtNum(props?.sup, 2)}</div>
            <div class="k">Especie</div><div class="v">${safeText(props?.DES_SP1)}</div>
            <div class="k">Estado</div><div class="v">${safeText(props?.DES_E1)}</div>
            <div class="k">Acompañante</div><div class="v">${safeText(props?.DES_SP2)}</div>
            <div class="k">FCC (%)</div><div class="v">${fmtNum(props?.FCCARB, 2)}</div>
          </div>
        </div>
      `;
    }

    // Init
    map.on('load', async () => {
      initYearSlider();
      initLegendHandlers();

      addMfvSourceAndLayersForYear(DEFAULT_YEAR);
      ensureBasemapBelow();
      await autoZoomToPmtiles(DEFAULT_YEAR);

      map.on('mouseenter', 'mfv-fill', () => setPointerCursor(true));
      map.on('mouseleave', 'mfv-fill', () => setPointerCursor(false));
      map.on('mouseenter', 'mfv-line', () => setPointerCursor(true));
      map.on('mouseleave', 'mfv-line', () => setPointerCursor(false));

      map.on('click', (e) => {
        const feats = map.queryRenderedFeatures(e.point, { layers: ['mfv-fill', 'mfv-line'] });
        if (!feats || feats.length === 0) return;

        const f = feats.find(x => x.layer && x.layer.id === 'mfv-fill') || feats[0];
        openMfvPopup(e.lngLat, f);

        const props = f.properties || {};
        const xy = `${e.lngLat.lng.toFixed(6)}, ${e.lngLat.lat.toFixed(6)}`;
        renderClickTab(props, xy);
        selectPanelTab('click'); // abre "Tesela"
      });

      yearSlider.addEventListener('input', async () => {
        activeYear = yearFromIndex(yearSlider.value);
        yearLabel.textContent = String(activeYear);

        await loadMfvYear(activeYear);

        if (ORTO_YEARS.includes(activeYear)) setBasemapYear(activeYear);
      });
    });
  </script>
</body>
</html>
